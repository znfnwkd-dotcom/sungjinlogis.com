---
import BaseLayout from '../../layouts/BaseLayout.astro';

const title = 'Contact | 성진로지스';
const description = '문의 — 기술/품질 중심 상담';
---

<BaseLayout title={title} description={description} lang="ko" pathPrefix="/kr">
  <section class="rounded-xl2 border border-stroke bg-surface p-8 shadow-soft">
    <h1 class="text-2xl font-semibold">Contact</h1>
    <p class="mt-2 text-sm text-sub">견적보다 신뢰(공정/품질) 중심의 상담을 우선합니다.</p>

    <div class="mt-6 rounded-xl border border-stroke bg-base p-5">
      <div class="text-sm font-semibold">Email</div>
      <p class="mt-1 text-sm text-sub">
        <a class="text-text hover:text-accent" href="mailto:contact@sungjinlogis.com">contact@sungjinlogis.com</a>
      </p>
    </div>

    <form id="contactForm" class="mt-8 grid gap-4 md:max-w-xl">
      <label class="grid gap-2">
        <span class="text-sm text-sub">이메일 *</span>
        <input class="rounded-xl border border-stroke bg-base px-4 py-3 text-sm" type="email" name="email" required placeholder="name@company.com" />
      </label>

      <label class="grid gap-2">
        <span class="text-sm text-sub">제목</span>
        <input class="rounded-xl border border-stroke bg-base px-4 py-3 text-sm" type="text" name="subject" placeholder="예) 도금 견적 문의" />
      </label>

      <label class="grid gap-2">
        <span class="text-sm text-sub">내용 *</span>
        <textarea class="min-h-[140px] rounded-xl border border-stroke bg-base px-4 py-3 text-sm" name="message" required placeholder="문의 내용을 입력해주세요."></textarea>
      </label>

      <!-- Honeypot -->
      <label class="hidden">
        <span>Leave this field empty</span>
        <input type="text" name="hp" autocomplete="off" />
      </label>

      <!-- Turnstile Widget (form 안에 있어야 함) -->
<div
  class="cf-turnstile"
  data-sitekey="0x4AAAAAACaY6RpQXbUGM9ai"
  data-theme="dark"
></div>

<!-- Turnstile script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  const form = document.getElementById('contactForm');
  const statusEl = document.getElementById('contactStatus');
  const btn = form.querySelector('button[type="submit"]');

  let submitting = false;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (submitting) return;

    statusEl.textContent = '전송 중...';
    submitting = true;
    btn.disabled = true;

    const fd = new FormData(form);

    // ✅ Turnstile이 자동으로 넣어주는 hidden input에서 토큰을 읽습니다.
    const tsToken = String(fd.get('cf-turnstile-response') || '').trim();

    if (!tsToken) {
      statusEl.textContent = '캡차 확인을 완료해주세요.';
      submitting = false;
      btn.disabled = false;
      return;
    }

    try {
      const res = await fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          lang: 'ko',
          email: fd.get('email'),
          subject: fd.get('subject'),
          message: fd.get('message'),
          hp: fd.get('hp'),
          // ✅ 서버에서 여러 이름으로 받게 해둘 거라 둘 중 하나만 보내도 됩니다.
          'cf-turnstile-response': tsToken,
        }),
      });

      const msg = await res.text();
      if (!res.ok) throw new Error(msg || 'Request failed');

      statusEl.textContent = '전송 완료! 확인 후 회신드리겠습니다.';
      form.reset();

      // ✅ 다음 제출을 위해 위젯 리셋
      if (window.turnstile) window.turnstile.reset();
    } catch (err) {
      statusEl.textContent = err?.message || '오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
      if (window.turnstile) window.turnstile.reset();
    } finally {
      submitting = false;
      btn.disabled = false;
    }
  });
</script>

</BaseLayout>
