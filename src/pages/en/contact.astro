---
import BaseLayout from '../../layouts/BaseLayout.astro';

const title = 'Contact | SUNGJINLOGIS';
const description = 'Inquiries — technical & quality-focused consultation.';
---

<BaseLayout title={title} description={description} lang="en" pathPrefix="/en">
  <section class="rounded-xl2 border border-stroke bg-surface p-8 shadow-soft">
    <h1 class="text-2xl font-semibold">Contact</h1>
    <p class="mt-2 text-sm text-sub">We prioritize process and quality-focused consultation over simple quote requests.</p>

    <div class="mt-6 rounded-xl border border-stroke bg-base p-5">
      <div class="text-sm font-semibold">Email</div>
      <p class="mt-1 text-sm text-sub">
        <a class="text-text hover:text-accent" href="mailto:contact@sungjinlogis.com">contact@sungjinlogis.com</a>
      </p>
    </div>

    <form id="contactForm" class="mt-8 grid gap-4 md:max-w-xl">
      <!-- inputs 동일 -->
      <label class="hidden"><span>Leave this field empty</span><input type="text" name="hp" autocomplete="off" /></label>

      <div class="cf-turnstile" data-sitekey="0x4AAAAAACaY6RpQXbUGM9ai" data-theme="dark"></div>

      <button class="rounded-xl bg-accent px-4 py-3 text-sm font-semibold text-white hover:bg-accent-hover transition" type="submit">
        Send inquiry
      </button>

      <p id="contactStatus" class="text-sm text-sub"></p>
    </form>
  </section>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <script>
    const form = document.getElementById('contactForm');
    const statusEl = document.getElementById('contactStatus');
    const btn = form.querySelector('button[type="submit"]');
    let submitting = false;

    function getTurnstileToken() {
      const el = form.querySelector('input[name="cf-turnstile-response"]');
      return (el && el.value ? String(el.value) : '').trim();
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitting) return;

      const token = getTurnstileToken();
      if (!token) {
        statusEl.textContent = 'Please complete the CAPTCHA.';
        return;
      }

      submitting = true;
      btn.disabled = true;
      statusEl.textContent = 'Sending...';

      const fd = new FormData(form);

      try {
        const res = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lang: 'en',
            email: fd.get('email'),
            subject: fd.get('subject'),
            message: fd.get('message'),
            hp: fd.get('hp'),
            turnstileToken: token,
          })
        });

        const msg = await res.text();
        if (!res.ok) throw new Error(msg || 'Request failed');

        statusEl.textContent = "Sent! We'll get back to you soon.";
        form.reset();
        if (window.turnstile) window.turnstile.reset();
      } catch (err) {
        statusEl.textContent = err?.message ? err.message : 'Something went wrong. Please try again.';
        if (window.turnstile) window.turnstile.reset();
      } finally {
        submitting = false;
        btn.disabled = false;
      }
    });
  </script>
</BaseLayout>
